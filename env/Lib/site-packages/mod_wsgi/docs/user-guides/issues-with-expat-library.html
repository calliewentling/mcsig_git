

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Issues With Expat Library &mdash; mod_wsgi 4.8.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="mod_wsgi 4.8.0 documentation" href="../index.html"/>
        <link rel="up" title="User Guides" href="../user-guides.html"/>
        <link rel="next" title="Configuration" href="../configuration.html"/>
        <link rel="prev" title="Issues With Pickle Module" href="issues-with-pickle-module.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> mod_wsgi
          

          
          </a>

          
            
            
              <div class="version">
                4.8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../project-status.html">Project Status</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security-issues.html">Security Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../user-guides.html">User Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quick-installation-guide.html">Quick Installation Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation-on-macosx.html">Installation On MacOS X</a></li>
<li class="toctree-l2"><a class="reference internal" href="quick-configuration-guide.html">Quick Configuration Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration-guidelines.html">Configuration Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation-issues.html">Installation Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration-issues.html">Configuration Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="application-issues.html">Application Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="frequently-asked-questions.html">Frequently Asked Questions</a></li>
<li class="toctree-l2"><a class="reference internal" href="checking-your-installation.html">Checking Your Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging-techniques.html">Debugging Techniques</a></li>
<li class="toctree-l2"><a class="reference internal" href="processes-and-threading.html">Processes And Threading</a></li>
<li class="toctree-l2"><a class="reference internal" href="reloading-source-code.html">Reloading Source Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="virtual-environments.html">Virtual Environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="access-control-mechanisms.html">Access Control Mechanisms</a></li>
<li class="toctree-l2"><a class="reference internal" href="file-wrapper-extension.html">File Wrapper Extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="registering-cleanup-code.html">Registering Cleanup Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="assorted-tips-and-tricks.html">Assorted Tips And Tricks</a></li>
<li class="toctree-l2"><a class="reference internal" href="issues-with-pickle-module.html">Issues With Pickle Module</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Issues With Expat Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-dreaded-segmentation-fault">The Dreaded Segmentation Fault</a></li>
<li class="toctree-l3"><a class="reference internal" href="#verifying-expat-is-the-problem">Verifying Expat Is The Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mismatch-in-versions-of-expat">Mismatch In Versions Of Expat</a></li>
<li class="toctree-l3"><a class="reference internal" href="#expat-version-used-by-apache">Expat Version Used By Apache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#expat-version-used-by-python">Expat Version Used By Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="#combining-python-and-apache">Combining Python And Apache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-system-expat-version">Updating System Expat Version</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../finding-help.html">Finding Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reporting-bugs.html">Reporting Bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../source-code.html">Source Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">Release Notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">mod_wsgi</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../user-guides.html">User Guides</a> &raquo;</li>
        
      <li>Issues With Expat Library</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/user-guides/issues-with-expat-library.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="issues-with-expat-library">
<h1>Issues With Expat Library<a class="headerlink" href="#issues-with-expat-library" title="Permalink to this headline">¶</a></h1>
<p>This article describes problems caused due to mismatches in the version of
the “expat” library embedded into Python and that linked into Apache. Where
incompatible versions are used, Apache can crash as soon as any Python code
module imports the “pyexpat” module.</p>
<p>Note that this only applies to Python versions prior to Python 2.5. From
Python 2.5 onwards, the copy of the “expat” library bundled in with Python
is name space prefixed, thereby avoid name clashes with an “expat” library
which has previously been loaded.</p>
<div class="section" id="the-dreaded-segmentation-fault">
<h2>The Dreaded Segmentation Fault<a class="headerlink" href="#the-dreaded-segmentation-fault" title="Permalink to this headline">¶</a></h2>
<p>When moving beyond creating simple WSGI applications to more complicated
tasks, one can unexpectedly be confronted with Apache crashing. This
generally manifests in no response being returned to the browser when a
request is made. Upon further investigation of the Apache error log file, a
message similar to the following message is found:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">notice</span><span class="p">]</span> <span class="n">child</span> <span class="n">pid</span> <span class="mi">3238</span> <span class="n">exit</span> <span class="n">signal</span> <span class="n">Segmentation</span> <span class="n">fault</span> <span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</pre></div>
</div>
<p>The change which causes this is the explicit addition of code to import the
Python module “pyexpat”, or the importing of any Python module which
indirectly makes use of the “pyexpat” module. Examples of other modules
which make use of the “pyexpat” module are “xmlrpclib” and modules from the
“PyXML” package. Nearly always, any module which in some way performs
processing of XML data will be affected as most such modules rely on using
the “pyexpat” module in some way.</p>
</div>
<div class="section" id="verifying-expat-is-the-problem">
<h2>Verifying Expat Is The Problem<a class="headerlink" href="#verifying-expat-is-the-problem" title="Permalink to this headline">¶</a></h2>
<p>To verify that the “pyexpat” module is the trigger for the problem,
construct a simple WSGI application script file containing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;200 OK&#39;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;without expat</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)))]</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">output</span><span class="p">]</span>
</pre></div>
</div>
<p>Verify that this handler works and the browser receives the response
“without pyepxat”. Now modify the handler such that the “pyexpat” module is
being imported. Also change the response so that it is clear that the
modified handler is being used:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyexpat</span>

<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;200 OK&#39;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;with expat</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)))]</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">output</span><span class="p">]</span>
</pre></div>
</div>
<p>Presuming that script reloading is enabled, if now upon a request being
received by the WSGI application a succesful response of “with pyexpat” is
received by the browser, it would generally indicate that the “pyexpat”
module is not the problem after all. If however no response is received and
the Apache error log records a “Segmentation fault” then the “pyexpat”
module is the trigger.</p>
</div>
<div class="section" id="mismatch-in-versions-of-expat">
<h2>Mismatch In Versions Of Expat<a class="headerlink" href="#mismatch-in-versions-of-expat" title="Permalink to this headline">¶</a></h2>
<p>Segmentation faults can occur with any application where different
components of the application were compiled against different versions of a
common library such as the “expat” library. The actual cause of the problem
is generally a change in the API of the library, such as changed function
prototypes, changed data types, or changes in structure layouts. In the
case where mod_wsgi is being used, the different components are Apache
and the “pyexpat” module from Python.</p>
<p>Normally when different components of an application are built, they would
be built against the same version of the library and such problems would
not occur. In the case of the “pyexpat” module however, it is compiled
against a distinct version of the “expat” library which is then embedded
within the “pyexpat” module. At the same time, Apache will be built against
the version of the “expat” library included with the operating system, or
if not a standard part of the operating system, a version which is supplied
with Apache.</p>
<p>Thus if the version of the “expat” library embedded into the “pyexpat”
module is different to that which Apache was compiled against, the
potential for this problem will exist. Note though that there may not
always be a problem. Whether there is or not will ultimately depend on what
changes were made in the “expat” library between the releases of the
different versions used. It is also possible how each library version was
compiled could be a factor.</p>
</div>
<div class="section" id="expat-version-used-by-apache">
<h2>Expat Version Used By Apache<a class="headerlink" href="#expat-version-used-by-apache" title="Permalink to this headline">¶</a></h2>
<p>To determine the version of the the “expat” library which is used by
Apache, on Linux the “ldd” command can be used. Other operating systems
also provide this program or will generally have some form of equivalent
program. For example, on Mac OS X the command which is run is “otool -L”.</p>
<p>The purpose of these programs is to generate a list of all shared libraries
that an application is linked against. To determine where the “expat”
library being used by Apache is located, it is necessary to run the “ldd”
program on the “httpd” program. On a Linux system, the “httpd” program is
normally located in “/usr/sbin”. Because we are only interested in the
“expat” library, we can ignore anything but the reference to that library:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[grahamd@dscpl grahamd]$ ldd /usr/sbin/httpd | grep expat
        libexpat.so.0 =&gt; /usr/lib/libexpat.so.0 (0xb7e8c000)
</pre></div>
</div>
<p>From this output it can be seen that the “httpd” program appears to be
using “/usr/lib/libexpat.so.0”. Although some operating systems embed in
the name of the shared library versioning information, it does not
generally indicate the true version of the code base which made up the
library. To obtain this, it is necessary to extract the version information
out of the library. For the “expat” library this can be determined by
searching within the strings contained in the library for a version string
starting with <code class="docutils literal"><span class="pre">expat_</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[grahamd@dscpl grahamd]$ strings /usr/lib/libexpat.so.0 | grep expat_
expat_1.95.8
</pre></div>
</div>
<p>The version of the “expat” library would therefore appear to be “1.95.8”.
Unfortunately though, many operating systems allow the library search path
to be overridden at the point that a program is run using an environment
variable such as “LD_LIBRARY_PATH” and it is quite possible that when
Apache is run, the context in which it is run could result in it finding
the “expat” library in a different location.</p>
<p>To be absolutely sure, it is necessary to determine which “expat” library
the running copy of Apache used. On Linux and many other operating systems,
this can be determined using the “lsof” command. If this program doesn’t
exist, an alternate program which may be available is “ofiles”. Either of
these should be run against one of the active Apache processes. If Apache
was originally started as root, the command will also need to be run as
root:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[grahamd@dscpl grahamd]$ ps aux | grep http | head -3
root      3625  0.0  0.6 31068 12836 ?       SN   Sep25   0:08 /usr/sbin/httpd
apache   24814  0.0  0.7 34196 15604 ?       SN   04:11   0:00 /usr/sbin/httpd
apache   24815  0.0  0.7 33924 15916 ?       SN   04:11   0:00 /usr/sbin/httpd

[grahamd@dscpl grahamd]$ sudo /usr/sbin/lsof -p 3625 | grep expat
httpd   3625 root  mem    REG     253,0   123552    6409040
/usr/lib/libexpat.so.0.5.0

[grahamd@dscpl grahamd]$ strings /usr/lib/libexpat.so.0.5.0 | grep expat_
expat_1.95.8
</pre></div>
</div>
</div>
<div class="section" id="expat-version-used-by-python">
<h2>Expat Version Used By Python<a class="headerlink" href="#expat-version-used-by-python" title="Permalink to this headline">¶</a></h2>
<p>To determine the version of the “expat” library which is embedded in the
Python “pyexpat” module, the module should be imported and the version
information extracted from the module. This can be done by executing
“python” on the command line and entering the necessary code directly:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[grahamd@dscpl grahamd]$ python
Python 2.3.3 (#1, May  7 2004, 10:31:40)
[GCC 3.3.3 20040412 (Red Hat Linux 3.3.3-7)] on linux2
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import pyexpat
&gt;&gt;&gt; pyexpat.version_info
(1, 95, 7)
</pre></div>
</div>
</div>
<div class="section" id="combining-python-and-apache">
<h2>Combining Python And Apache<a class="headerlink" href="#combining-python-and-apache" title="Permalink to this headline">¶</a></h2>
<p>When mod_wsgi is used from within Apache, although there is a version of
the “expat” library embedded in the “pyexpat” module, it will effectively
be ignored. This is because Apache has already loaded into memory at
startup the version of the “expat” library which it is linked against. That
this occurs can be seen by using the ability of Linux to forcibly preload a
shared library into a program when run, even though that program wasn’t
linked against the library orginally. This is achieved using the
“LD_PRELOAD” environment variable:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[grahamd@dscpl grahamd]$ LD_PRELOAD=/usr/lib/libexpat.so.0.5.0 python
Python 2.3.3 (#1, May  7 2004, 10:31:40)
[GCC 3.3.3 20040412 (Red Hat Linux 3.3.3-7)] on linux2
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import pyexpat
&gt;&gt;&gt; pyexpat.version_info
(1, 95, 8)
</pre></div>
</div>
<p>As can be seen, although the “pyexpat” module for this version of Python
embedded version 1.95.7 of the “expat” library, when the same version of
the “expat” library as was being used by Apache is forcibly loaded into the
program at startup, the version information obtained from the “pyexpat”
module now shows that version 1.95.8 of the “expat” library is being used.</p>
<p>Luckily in this case, the patch level difference between the two versions
of the “expat” library as used by Python and Apache doesn’t cause a
problem. If however the two versions of the “expat” library were
incompatible, one would expect to see the “python” program crash with a
segmentation fault at this point. This therefore can be used as an
alternate way of verifying that it is the “pyexpat” module and more
specifically the version of the “expat” library used, that is causing the
problem.</p>
</div>
<div class="section" id="updating-system-expat-version">
<h2>Updating System Expat Version<a class="headerlink" href="#updating-system-expat-version" title="Permalink to this headline">¶</a></h2>
<p>Because the version of the “expat” library embedded within the “pyexpat”
module is shipped as source code within the Python distribution, it can be
hard to replace it. The preferred approach to resolving the mismatch is
therefore to replace/update the version of the “expat” library that is used
by Apache.</p>
<p>Generally the problem occurs where that used by Apache is older than that
which is being used by Python. In that case, the version of the “expat”
library used by Apache should be updated to be the same version as that
embedded within the “pyexpat” module. By using the same version, one would
expect any problems to disappear. If problems still persist, it is possible
that Apache may also need to be recompiled against the same version of the
“expat” library as used in Python.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../configuration.html" class="btn btn-neutral float-right" title="Configuration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="issues-with-pickle-module.html" class="btn btn-neutral" title="Issues With Pickle Module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2007-2020, Graham Dumpleton.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'4.8.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>